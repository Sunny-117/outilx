import { useState } from 'react';
import { useSSE } from '@outilx/ai';

function SSEDemo() {
  const [url, setUrl] = useState('/sse');
  const [logs, setLogs] = useState<string[]>([]);

  const addLog = (message: string) => {
    const timestamp = new Date().toLocaleTimeString();
    setLogs((prev) => [...prev, `[${timestamp}] ${message}`]);
  };

  const { state, messages, connect, disconnect, clearMessages } = useSSE({
    url,
    onOpen: () => addLog('âœ“ SSE è¿æ¥å·²å»ºç«‹'),
    onMessage: (data) => addLog(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${data}`),
    onError: () => addLog('âœ— SSE è¿æ¥é”™è¯¯'),
  });

  return (
    <div>
      <h2>SSE (Server-Sent Events) Demo</h2>
      <p>å®æ—¶æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„æ•°æ®</p>

      <div style={{ marginBottom: '20px', padding: '15px', background: '#fff3cd', borderRadius: '4px' }}>
        <strong>âš ï¸ æ³¨æ„ï¼š</strong> éœ€è¦å…ˆå¯åŠ¨ SSE æœåŠ¡å™¨
        <pre style={{ margin: '10px 0 0 0', padding: '10px', background: '#fff', borderRadius: '4px', fontSize: '13px' }}>
          {`# åœ¨æ–°ç»ˆç«¯çª—å£è¿è¡Œï¼š
cd packages/ai/sse
node server.js

# æœåŠ¡å™¨å°†è¿è¡Œåœ¨ http://localhost:3001
# SSE ç«¯ç‚¹: http://localhost:3001/sse`}
        </pre>
        {state === 'error' && (
          <div style={{ marginTop: '10px', padding: '10px', background: '#f8d7da', color: '#721c24', borderRadius: '4px' }}>
            <strong>è¿æ¥å¤±è´¥ï¼</strong> è¯·ç¡®ä¿ï¼š
            <ul style={{ margin: '5px 0 0 0', paddingLeft: '20px' }}>
              <li>SSE æœåŠ¡å™¨å·²å¯åŠ¨</li>
              <li>URL åœ°å€æ­£ç¡®</li>
              <li>æ²¡æœ‰è¢«é˜²ç«å¢™é˜»æ­¢</li>
            </ul>
          </div>
        )}
      </div>

      <div style={{ marginBottom: '20px' }}>
        <h3>é…ç½®ï¼š</h3>
        <div style={{ marginBottom: '10px' }}>
          <label>
            SSE URL: 
            <input
              type="text"
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              style={{ marginLeft: '10px', padding: '5px', width: '300px' }}
              disabled={state === 'connected'}
            />
          </label>
        </div>
        <div>
          <strong>çŠ¶æ€ï¼š</strong>{' '}
          <span
            style={{
              padding: '4px 8px',
              borderRadius: '4px',
              background:
                state === 'connected'
                  ? '#d4edda'
                  : state === 'error'
                  ? '#f8d7da'
                  : state === 'connecting'
                  ? '#fff3cd'
                  : '#e2e3e5',
              color:
                state === 'connected'
                  ? '#155724'
                  : state === 'error'
                  ? '#721c24'
                  : state === 'connecting'
                  ? '#856404'
                  : '#383d41',
            }}
          >
            {state === 'connected' && 'ğŸŸ¢ å·²è¿æ¥'}
            {state === 'connecting' && 'ğŸŸ¡ è¿æ¥ä¸­...'}
            {state === 'error' && 'ğŸ”´ é”™è¯¯'}
            {state === 'disconnected' && 'âšª æœªè¿æ¥'}
          </span>
        </div>
      </div>

      <div style={{ marginBottom: '20px' }}>
        <button
          onClick={connect}
          disabled={state === 'connected' || state === 'connecting'}
          style={{
            padding: '10px 20px',
            marginRight: '10px',
            cursor: state === 'connected' || state === 'connecting' ? 'not-allowed' : 'pointer',
            background: state === 'connected' || state === 'connecting' ? '#ccc' : '#4CAF50',
            color: '#fff',
            border: 'none',
            borderRadius: '4px',
          }}
        >
          è¿æ¥
        </button>
        <button
          onClick={disconnect}
          disabled={state === 'disconnected'}
          style={{
            padding: '10px 20px',
            marginRight: '10px',
            cursor: state === 'disconnected' ? 'not-allowed' : 'pointer',
            background: state === 'disconnected' ? '#ccc' : '#f44336',
            color: '#fff',
            border: 'none',
            borderRadius: '4px',
          }}
        >
          æ–­å¼€è¿æ¥
        </button>
        <button
          onClick={() => {
            clearMessages();
            setLogs([]);
          }}
          style={{
            padding: '10px 20px',
            cursor: 'pointer',
            background: '#ff9800',
            color: '#fff',
            border: 'none',
            borderRadius: '4px',
          }}
        >
          æ¸…ç©ºæ¶ˆæ¯
        </button>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
        <div>
          <h3>æ¥æ”¶åˆ°çš„æ¶ˆæ¯ ({messages.length})ï¼š</h3>
          <div
            style={{
              padding: '10px',
              background: '#f5f5f5',
              border: '1px solid #ddd',
              borderRadius: '4px',
              minHeight: '300px',
              maxHeight: '400px',
              overflow: 'auto',
            }}
          >
            {messages.length === 0 ? (
              <div style={{ color: '#999' }}>æš‚æ— æ¶ˆæ¯</div>
            ) : (
              messages.map((msg, index) => (
                <div
                  key={index}
                  style={{
                    padding: '8px',
                    marginBottom: '5px',
                    background: '#fff',
                    border: '1px solid #e0e0e0',
                    borderRadius: '4px',
                  }}
                >
                  {msg}
                </div>
              ))
            )}
          </div>
        </div>

        <div>
          <h3>æ—¥å¿—ï¼š</h3>
          <div
            style={{
              padding: '10px',
              background: '#f5f5f5',
              border: '1px solid #ddd',
              borderRadius: '4px',
              minHeight: '300px',
              maxHeight: '400px',
              overflow: 'auto',
              fontFamily: 'monospace',
              fontSize: '12px',
            }}
          >
            {logs.length === 0 ? (
              <div style={{ color: '#999' }}>æš‚æ— æ—¥å¿—</div>
            ) : (
              logs.map((log, index) => (
                <div key={index} style={{ marginBottom: '3px' }}>
                  {log}
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default SSEDemo;
